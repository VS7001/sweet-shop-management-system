<!DOCTYPE html>
<html>
<head>
    <title>Sweet Shop Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h2 {
            margin-top: 30px;
        }

        input, button {
            padding: 6px;
            margin: 4px 0;
        }

        button {
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .sweet {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>Sweet Shop Management System</h1>

<!-- LOGIN -->
<div id="loginSection">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>
        Not registered?
        <button onclick="showRegister()">Register</button>
    </p>
</div>

<!-- REGISTER -->
<div id="registerSection" class="hidden">
    <h2>Register</h2>
    <input id="regEmail" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Password">
    <button onclick="register()">Register</button>
    <button onclick="showLogin()">Back to Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

    <!-- SEARCH -->
    <h2>Search Sweets</h2>
    <div class="row">
        <input id="searchName" placeholder="Name">
        <input id="searchCategory" placeholder="Category">
        <input id="minPrice" type="number" placeholder="Min Price">
        <input id="maxPrice" type="number" placeholder="Max Price">
        <button onclick="searchSweets()">Search</button>
        <button onclick="loadSweets()">Show All</button>
    </div>

    <!-- ADD SWEET -->
    <h2>Add Sweet</h2>
    <div class="row">
        <input id="sweetName" placeholder="Name">
        <input id="sweetCategory" placeholder="Category">
        <input id="sweetPrice" type="number" placeholder="Price">
        <input id="sweetQuantity" type="number" placeholder="Quantity">
        <button onclick="addSweet()">Add Sweet</button>
    </div>

    <!-- SWEETS LIST -->
    <h2>Available Sweets</h2>
    <div id="sweets"></div>
</div>

<script>
let token = "";

/* ---------- AUTH ---------- */

function showRegister() {
    loginSection.classList.add("hidden");
    registerSection.classList.remove("hidden");
}

function showLogin() {
    registerSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
}

function register() {
    fetch("http://127.0.0.1:8000/api/auth/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            email: regEmail.value,
            password: regPassword.value
        })
    }).then(r => {
        if (!r.ok) throw new Error("Registration failed");
        alert("Registered successfully. Please login.");
        regEmail.value = "";
        regPassword.value = "";
        showLogin();
    }).catch(e => alert(e.message));
}

function login() {
    fetch("http://127.0.0.1:8000/api/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            email: loginEmail.value,
            password: loginPassword.value
        })
    }).then(r => {
        if (!r.ok) throw new Error("Login failed");
        return r.json();
    }).then(d => {
        token = d.access_token;
        loginSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadSweets();
    }).catch(e => alert(e.message));
}

/* ---------- SWEETS ---------- */

function addSweet() {
    fetch("http://127.0.0.1:8000/api/sweets", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            name: sweetName.value,
            category: sweetCategory.value,
            price: Number(sweetPrice.value),
            quantity: Number(sweetQuantity.value)
        })
    }).then(() => {
        sweetName.value = "";
        sweetCategory.value = "";
        sweetPrice.value = "";
        sweetQuantity.value = "";
        loadSweets();
    });
}

function loadSweets() {
    fetch("http://127.0.0.1:8000/api/sweets")
        .then(r => r.json())
        .then(renderSweets);
}

function searchSweets() {
    const params = new URLSearchParams();

    if (searchName.value) params.append("name", searchName.value);
    if (searchCategory.value) params.append("category", searchCategory.value);
    if (minPrice.value) params.append("min_price", minPrice.value);
    if (maxPrice.value) params.append("max_price", maxPrice.value);

    fetch(`http://127.0.0.1:8000/api/sweets/search?${params.toString()}`)
        .then(r => r.json())
        .then(renderSweets);
}

function renderSweets(data) {
    sweets.innerHTML = "";

    if (data.length === 0) {
        sweets.innerHTML = "No sweets found";
        return;
    }

    data.forEach(s => {
        sweets.innerHTML += `
            <div class="sweet">
                <b>${s.name}</b><br>
                Category: ${s.category}<br>
                Price: ${s.price}<br>
                Quantity: ${s.quantity}<br><br>

                <input id="price-${s.id}" type="number" value="${s.price}">
                <input id="qty-${s.id}" type="number" value="${s.quantity}">
                <button onclick="updateSweet(${s.id})">Update</button>

                <button onclick="purchase(${s.id})" ${s.quantity === 0 ? "disabled" : ""}>
                    Purchase
                </button>
            </div>
        `;
    });
}

function updateSweet(id) {
    fetch(`http://127.0.0.1:8000/api/sweets/${id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            price: Number(document.getElementById(`price-${id}`).value),
            quantity: Number(document.getElementById(`qty-${id}`).value)
        })
    }).then(() => loadSweets());
}

function purchase(id) {
    fetch(`http://127.0.0.1:8000/api/sweets/${id}/purchase`, {
        method: "POST"
    }).then(() => loadSweets());
}
</script>

</body>
</html>
